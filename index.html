<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ダメージ計算＆DPSツール</title>
  <style>
    html, body { height: 95%; margin: 10; padding: 10; }
    .container { display: flex; flex-direction: column; height: 95vh; }
    #scrollable-content { flex: 1; overflow-y: auto; padding: 10px; min-height: 0; }
    #graph-container { height: 50vh !important; width: 100%; overflow: hidden; }
    #damageGraph { height: 50vh !important; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid black; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    input[type="number"]:not([readonly]), select:not([readonly]), input[type="checkbox"]:not([readonly]) { background-color: #ffffcc; }
    input[type="number"], input[type="text"] { width: 60px; }
    button { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.05s ease; font-size: 1em; box-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2); min-width: 80px; height: 40px; margin-right: 5px; }
    button.on { background-color: #008000; color: white; }
    button.off { background-color: #DDDDDD; color: black; }
    button:hover { opacity: 0.8; }
    button.weapon { background-color: #87CEEB; color: black; }
    button.weapon.on { background-color: #0000FF; color: white; }
    button.weaponMod { background-color: #87CEEB; color: black; }
    button.weaponMod.on { background-color: #0000FF; color: white; }
    button.legendary.on { background-color: #FFA500; color: white; }
  </style>
</head>
<body>
  <div class="container">
    <div id="scrollable-content">
      <table>
        <thead>
          <tr><th>通常ダメージ</th><td> ベース <input type="text" id="finalDamageTotal" readonly> FT <input type="text" id="ftDamage" readonly> TOFT <input type="text" id="toftDamage" readonly> ラスト <input type="text" id="lowHealthDamage" readonly> </td></tr>
          <tr><th>クリティカル</th><td> ベース <input type="text" id="finalCriticalDamageTotal" readonly> FT <input type="text" id="ftCriticalDamage" readonly> TOFT <input type="text" id="toftCriticalDamage" readonly> ラスト <input type="text" id="lowHealthCriticalDamage" readonly> </td></tr>
        </thead>
        <tbody>
          <tr><th>プリセット</th><td><select id="presetSelect" onchange="applyPreset()"><option value="default">デフォルト</option><option value="preset1">プリセット1</option><option value="preset2">プリセット2</option></select></td></tr>
          <tr><th>攻撃対象</th><td><button id="ultraciteTerrorButton" class="on" onclick="toggleExclusiveBonus('ultraciteTerror')">ウルトラサイトテラー</button><button id="en06Button" class="off" onclick="toggleExclusiveBonus('en06')">EN06</button></td></tr>
          <tr><th>攻撃部位</th><td><button id="eyeButton" class="on" onclick="toggleExclusiveBonus('eye')">目</button><button id="headButton" class="off" onclick="toggleExclusiveBonus('head')">頭</button><button id="bodyButton" class="off" onclick="toggleExclusiveBonus('body')">胴体</button></td></tr>
          <tr>
            <th>武器</th>
            <td>
              <button id="gatPlasmaButton" class="on weapon" onclick="toggleWeapon('gatPlasma')">ガトプラ</button>
              <button id="railRifleButton" class="off weapon" onclick="toggleWeapon('railRifle')">レールライフル</button>
            </td>
          </tr>
          <tr>
            <th>武器MOD</th>
            <td>
              <span id="gatPlasmaMods" style="display: inline;">
                <button id="stingingCoreButton" class="on weaponMod" onclick="toggleBonus('stingingCore')">スティングコア</button>
                <button id="swiftCoreButton" class="off weaponMod" onclick="toggleExclusiveBonus('swiftCore')">スウィフトコア</button>
                <button id="primeButton" class="off weaponMod" onclick="toggleExclusiveBonus('prime')">プライムレシーバー</button>
                <button id="calibrateButton" class="on weaponMod" onclick="toggleExclusiveBonus('calibrate')">キャリブレートレシーバー</button>
                <button id="acceralateButton" class="on weaponMod" onclick="toggleBonus('acceralate')">アクセラレートノズル</button>
              </span>
              <span id="railRifleMods" style="display: none;">
                <button id="autoPistonButton" class="on weaponMod" onclick="toggleBonus('autoPiston')">オートピストン</button>
                <button id="primeRailButton" class="off weaponMod" onclick="toggleExclusiveBonus('primeRail')">プライムレシーバー</button>
              </span>
            </td>
          </tr>
          <tr><th>★1伝説効果</th><td><button id="bloodiedButton" class="on" onclick="toggleExclusiveBonus('bloodied')">血濡れ</button><button id="antiArmorButton" class="off" onclick="toggleExclusiveBonus('antiArmor')">対アーマー</button><button id="excusionerButton" class="off" onclick="toggleExclusiveBonus('excusioner')">処刑人</button></td></tr>
          <tr><th>★2伝説効果</th><td><button id="rapidButton" class="on" onclick="toggleExclusiveBonus('rapid')">迅速</button><button id="vitalButton" class="off" onclick="toggleExclusiveBonus('vital')">バイタル</button></td></tr>
          <tr>
            <th>★3伝説効果</th>
            <td>
              <button id="rangersButton" class="on" onclick="toggleBonus('rangers')">Ranger's</button>
              <button id="pinPointersButton" class="on" onclick="toggleBonus('pinPointers')">Pin-Pointer's</button>
              <button id="reloadSpeedButton" class="off" onclick="toggleBonus('reloadSpeed')">リロ速</button>
            </td>
          </tr>
          <tr><th>総ダメージボーナス</th><td><input type="number" id="damageBonus" value="100" readonly> %</td></tr>
          <tr><th>総クリティカルボーナス</th><td><input type="number" id="criticalBonus" value="100" readonly> %</td></tr>
          <tr><th>ダメージ系Perk</th><td><button id="heavyGunnerButton" class="on" onclick="toggleBonus('heavyGunner')">HeavyGunner</button><button id="betterCriticalsButton" class="on" onclick="toggleBonus('betterCriticals')">Better Criticals</button><button id="bMessButton" class="on" onclick="toggleBonus('bMess')">Bloody Mess</button><button id="nerdRageButton" class="on" onclick="toggleBonus('nerdRage')">Nerd Rage</button></td></tr>
          <tr><th>アーマー貫通系Perk</th><td><button id="stabilizedButton" class="on" onclick="toggleBonus('stabilized')">Stabilized</button></td></tr>
          <tr><th>その他Perk</th><td><button id="sinButton" class="on" onclick="toggleBonus('sin')">Strange in Numbers</button><button id="perkMultiplierButton" class="on" onclick="toggleBonus('perkMultiplier')">Taking one for the Team</button><button id="followThroughButton" class="on" onclick="toggleBonus('followThrough')">Follow Through</button></td></tr>
          <tr><th>変異</th><td><button id="eagleEyesButton" class="on" onclick="toggleBonus('eagleEyes')">ワシの目</button><button id="adrenalRButton" class="on" onclick="toggleBonus('adrenalR')">副腎反応</button></td></tr>
          <tr><th>バフ系</th><td><button id="blightSoupButton" class="on" onclick="toggleBonus('blightSoup')">ブライトのスープ</button><button id="oDriveButton" class="on" onclick="toggleExclusiveBonus('oDrive')">オーバードライブ</button><button id="phyBuffButton" class="off" onclick="toggleExclusiveBonus('phyBuff')">サイコバフ</button><button id="heavyGunsButton" class="on" onclick="toggleBonus('heavyGuns')">HeavyGuns</button><button id="teslaScience9Button" class="off" onclick="toggleBonus('teslaScience9')">テスラサイエンス９</button></td></tr>
          <tr><th>発射速度</th><td><input type="text" id="firingRate" readonly> 発/秒 </td></tr>
          <tr>
            <th>マガジンサイズ</th>
            <td>
              <select id="magazineSizeSelect" onchange="calculateDamage()">
                <option value="gatPlasma375" selected>ガトプラ 375</option>
                <option value="gatPlasma500">ガトプラ 500</option>
                <option value="railRifle10">レールライフル 10</option>
                <option value="railRifle40">レールライフル 40</option>
              </select>
            </td>
          </tr>
          <tr><th>DPS</th><td><input type="text" id="dps" readonly></td></tr>
          <tr><th>討伐時間</th><td><input type="text" id="killTime" readonly> 秒</td></tr>
          <tr><th>PipBoy表記ダメ（物理/エネルギー）</th><td><input type="text" id="gameDisplayDamagePhysical" readonly>/<input type="text" id="gameDisplayDamageEnergy" readonly></td></tr>
          <tr><th>机上のダメージ（物理/エネルギー）</th><td><input type="text" id="damageOnPaperPhysical" readonly>/<input type="text" id="damageOnPaperEnergy" readonly></td></tr>
          <tr><th>アーマー貫通後耐性（物理/エネルギー）</th><td><input type="text" id="enemyDamageResistancePhysicalAfterArmorPen" readonly>/<input type="text" id="enemyDamageResistanceEnergyAfterArmorPen" readonly></td></tr>
          <tr><th>最終通常ダメージ(物理/エネルギー)</th><td><input type="text" id="finalDamagePhysical" readonly>/<input type="text" id="finalDamageEnergy" readonly></td></tr>
          <tr><th>クリダメ加算（物理/エネルギー）</th><td><input type="text" id="criticalDamageAddPhysical" readonly>/<input type="text" id="criticalDamageAddEnergy" readonly></td></tr>
          <tr><th>机上のクリダメ（物理/エネルギー）</th><td><input type="text" id="criticalDamagePaperPhysical" readonly>/<input type="text" id="criticalDamagePaperEnergy" readonly></td></tr>
          <tr><th>最終クリダメ（物理/エネルギー）</th><td><input type="text" id="finalCriticalDamagePhysical" readonly>/<input type="text" id="finalCriticalDamageEnergy" readonly></td></tr>
        </tbody>
      </table>
    </div>
    <div id="graph-container">
      <canvas id="damageGraph"></canvas>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/chartjs-plugin-annotation.min.js"></script>
  <script>
    const BASE_DAMAGE_BONUS = 1;
    let state = {
      bMessActive: true, primeActive: false, calibrateActive: true, adrenalRActive: true,
      bloodiedActive: true, antiArmorActive: false, excusionerActive: false, blightSoupActive: true,
      heavyGunsActive: true, teslaScience9Active: false, oDriveActive: true, phyBuffActive: false,
      perkMultiplierActive: true, followThroughActive: true, stabilizedActive: false, stingingCoreActive: true,
      pinPointersActive: true, acceralateActive: true, rapidActive: true, vitalActive: false,
      ultraciteTerrorActive: true, en06Active: false,
      eyeActive: true, headActive: false, bodyActive: false,
      gatPlasmaActive: true, railRifleActive: false, autoPistonActive: true, primeRailActive: false,
      swiftCoreActive: false, reloadSpeedActive: false,
      eagleEyesActive: true,
      rangersActive: false,
      nerdRageActive: true,
      betterCriticalsActive: true,
      heavyGunnerActive: true,
      sinActive: true,
      gatPlasmaModsState: {
        stingingCoreActive: true,
        swiftCoreActive: false,
        primeActive: false,
        calibrateActive: true,
        acceralateActive: true
      }
    };
    let chart;

    const resistances = {
      ultraciteTerror: { physical: 183, energy: 213 },
      en06: { physical: 341, energy: 169 }
    };
    const bodyPartMultipliers = {
      eye: 300, head: 200, body: 100
    };
    const weaponData = {
      gatPlasma: {
        damages: { physical: 35, energy: 35 },
        magazineSizes: [375, 500],
        baseReloadTime: 5
      },
      railRifle: {
        damages: { physical: 90, energy: 0 },
        magazineSizes: [10, 40],
        baseReloadTime: 2
      }
    };

    function applyPreset() {
      const preset = document.getElementById("presetSelect").value;
      const defaults = { ultraciteTerrorActive: true, en06Active: false, eyeActive: true, headActive: false, bodyActive: false, gatPlasmaActive: true, eagleEyesActive: false, rangersActive: true, nerdRageActive: true, betterCriticalsActive: true, heavyGunnerActive: true, sinActive: true };
      const presets = {
        preset1: { ...Object.keys(state).reduce((acc, key) => ({ ...acc, [key]: false }), {}), ...defaults },
        preset2: { bMessActive: true, primeActive: true, calibrateActive: false, adrenalRActive: true,
          bloodiedActive: false, antiArmorActive: true, excusionerActive: false, blightSoupActive: true,
          heavyGunsActive: true, teslaScience9Active: true, oDriveActive: false, phyBuffActive: true,
          perkMultiplierActive: true, followThroughActive: false, stabilizedActive: true, stingingCoreActive: true,
          pinPointersActive: true, acceralateActive: true, rapidActive: true, vitalActive: false, ...defaults },
        default: { ...state }
      };
      state = { ...presets[preset] || presets.default };
      updateButtons();
      calculateDamage();
    }

    function toggleBonus(bonus) {
      state[bonus + "Active"] = !state[bonus + "Active"];
      updateButtonClass(bonus + "Button", state[bonus + "Active"]);
      calculateDamage();
    }

    function toggleExclusiveBonus(bonus) {
      const exclusiveGroups = {
        prime: ["calibrate", "swiftCore"],
        calibrate: ["prime", "swiftCore"],
        swiftCore: ["prime", "calibrate"],
        oDrive: ["phyBuff"],
        bloodied: ["antiArmor", "excusioner"],
        antiArmor: ["bloodied", "excusioner"],
        excusioner: ["bloodied", "antiArmor"],
        phyBuff: ["oDrive"],
        ultraciteTerror: ["en06"],
        en06: ["ultraciteTerror"],
        eye: ["head", "body"],
        head: ["eye", "body"],
        body: ["eye", "head"],
        rapid: ["vital"],
        vital: ["rapid"]
      };
      state[bonus + "Active"] = !state[bonus + "Active"];
      exclusiveGroups[bonus]?.forEach(ex => state[ex + "Active"] = false);
      updateButtons();
      calculateDamage();
    }

    function updateButtonClass(buttonId, isActive) {
      const button = document.getElementById(buttonId);
      if (button) {
        button.classList.remove("on", "off");
        button.classList.add(isActive ? "on" : "off");
      }
    }

    function updateButtons() {
      Object.keys(state).forEach(key => {
        const buttonId = key.replace("Active", "Button");
        const button = document.getElementById(buttonId);
        if (button) {
          button.classList.remove("on", "off");
          button.classList.add(state[key] ? "on" : "off");
          if (["bloodied", "antiArmor", "excusioner", "rapid", "vital", "rangers", "pinPointers"].includes(key.replace("Active", ""))) {
            button.classList.add("legendary");
          }
        }
      });
    }

    function toggleWeapon(weapon) {
      if (weapon === "gatPlasma") {
        state.gatPlasmaActive = true;
        state.railRifleActive = false;
        Object.assign(state, state.gatPlasmaModsState);
        document.getElementById("gatPlasmaMods").style.display = "inline";
        document.getElementById("railRifleMods").style.display = "none";
      } else if (weapon === "railRifle") {
        state.gatPlasmaActive = false;
        state.railRifleActive = true;
        state.gatPlasmaModsState = {
          stingingCoreActive: state.stingingCoreActive,
          swiftCoreActive: state.swiftCoreActive,
          primeActive: state.primeActive,
          calibrateActive: state.calibrateActive,
          acceralateActive: state.acceralateActive
        };
        state.stingingCoreActive = false;
        state.swiftCoreActive = false;
        state.primeActive = false;
        state.calibrateActive = false;
        state.acceralateActive = false;
        document.getElementById("gatPlasmaMods").style.display = "none";
        document.getElementById("railRifleMods").style.display = "inline";
      }
      updateButtons();
      calculateDamage();
    }

    function calculateDamage() {
      const enemyType = state.ultraciteTerrorActive ? "ultraciteTerror" : "en06";
      const bodyPart = state.eyeActive ? "eye" : state.headActive ? "head" : "body";
      const weapon = state.gatPlasmaActive ? "gatPlasma" : "railRifle";
      const magazineSizeSelect = document.getElementById("magazineSizeSelect").value;
      const isGatPlasma = weapon === "gatPlasma";
      const magazineSize = magazineSizeSelect === (isGatPlasma ? "gatPlasma500" : "railRifle40") ?
        weaponData[weapon].magazineSizes[1] : weaponData[weapon].magazineSizes[0];

      const inputs = {
        weaponBaseDamagePhysical: weaponData[weapon].damages.physical,
        weaponBaseDamageEnergy: weaponData[weapon].damages.energy,
        bodyPartMultiplier: bodyPartMultipliers[bodyPart] / 100,
        enemyDamageResistancePhysical: resistances[enemyType].physical,
        enemyDamageResistanceEnergy: resistances[enemyType].energy
      };

      const multipliers = {
        pinPointersMultiplier: state.pinPointersActive ? 1.5 : 1,
        armorPenPerk: state.stabilizedActive ? 0.45 : 0,
        armorPenWeapon: state.stingingCoreActive ? 0.20 : 0,
        armorPenAntiArmor: state.antiArmorActive ? 0.50 : 0
      };

      let damageBonus = BASE_DAMAGE_BONUS +
        (state.bMessActive ? 0.15 : 0) + (state.primeActive ? 0.20 : 0) +
        (state.adrenalRActive ? (state.sinActive ? 0.625 : 0.50) : 0) +
        (state.bloodiedActive ? 0.95 : 0) + (state.heavyGunsActive ? 0.20 : 0) +
        (state.oDriveActive ? 0.15 : 0) + (state.phyBuffActive ? 0.25 : 0) +
        (state.rangersActive ? 0.25 : 0) + (state.nerdRageActive ? 0.20 : 0) +
        (state.heavyGunnerActive ? 0.60 : 0);
      let criticalBonus = 1 + (state.calibrateActive ? 1.00 : 0) +
        (state.blightSoupActive ? (state.sinActive ? 1.25 : 1.00) : 0) +
        (state.teslaScience9Active ? 1.00 : 0) + (state.oDriveActive ? 0.30 : 0) +
        (state.eagleEyesActive ? (state.sinActive ? 0.625 : 0.50) : 0) +
        (state.betterCriticalsActive ? 1.00 : 0) +
        (state.vitalActive ? 0.50 : 0);

      document.getElementById("damageBonus").value = Math.round(damageBonus * 100);
      document.getElementById("criticalBonus").value = Math.round(criticalBonus * 100);

      const gameDisplayDamage = {
        physical: inputs.weaponBaseDamagePhysical * damageBonus,
        energy: inputs.weaponBaseDamageEnergy * damageBonus
      };
      document.getElementById("gameDisplayDamagePhysical").value = Math.round(gameDisplayDamage.physical);
      document.getElementById("gameDisplayDamageEnergy").value = Math.round(gameDisplayDamage.energy);

      const damageOnPaper = {
        physical: inputs.weaponBaseDamagePhysical * damageBonus * inputs.bodyPartMultiplier * multipliers.pinPointersMultiplier,
        energy: inputs.weaponBaseDamageEnergy * damageBonus * inputs.bodyPartMultiplier * multipliers.pinPointersMultiplier
      };
      const resistanceAfterArmor = {
        physical: inputs.enemyDamageResistancePhysical * (1 - multipliers.armorPenPerk) * (1 - multipliers.armorPenWeapon) * (1 - multipliers.armorPenAntiArmor),
        energy: inputs.enemyDamageResistanceEnergy * (1 - multipliers.armorPenPerk) * (1 - multipliers.armorPenWeapon) * (1 - multipliers.armorPenAntiArmor)
      };
      const resistanceCoeff = {
        physical: Math.min(Math.pow((damageOnPaper.physical * 0.15 / resistanceAfterArmor.physical), 0.365), 0.99),
        energy: Math.min(Math.pow((damageOnPaper.energy * 0.15 / resistanceAfterArmor.energy), 0.365), 0.99)
      };
      const finalDamage = {
        physical: damageOnPaper.physical * resistanceCoeff.physical,
        energy: damageOnPaper.energy * resistanceCoeff.energy
      };

      document.getElementById("enemyDamageResistancePhysicalAfterArmorPen").value = Math.round(resistanceAfterArmor.physical);
      document.getElementById("enemyDamageResistanceEnergyAfterArmorPen").value = Math.round(resistanceAfterArmor.energy);

      const criticalDamageAdd = {
        physical: inputs.weaponBaseDamagePhysical * criticalBonus * inputs.bodyPartMultiplier,
        energy: inputs.weaponBaseDamageEnergy * criticalBonus * inputs.bodyPartMultiplier
      };
      const criticalDamagePaper = {
        physical: damageOnPaper.physical + criticalDamageAdd.physical,
        energy: damageOnPaper.energy + criticalDamageAdd.energy
      };
      document.getElementById("damageOnPaperPhysical").value = Math.round(damageOnPaper.physical);
      document.getElementById("damageOnPaperEnergy").value = Math.round(damageOnPaper.energy);
      document.getElementById("criticalDamageAddPhysical").value = Math.round(criticalDamageAdd.physical);
      document.getElementById("criticalDamageAddEnergy").value = Math.round(criticalDamageAdd.energy);
      document.getElementById("criticalDamagePaperPhysical").value = Math.round(criticalDamagePaper.physical);
      document.getElementById("criticalDamagePaperEnergy").value = Math.round(criticalDamagePaper.energy);

      const finalCriticalDamage = {
        physical: resistanceAfterArmor.physical !== 0 ? criticalDamagePaper.physical * Math.min(Math.pow((criticalDamagePaper.physical * 0.15 / resistanceAfterArmor.physical), 0.365), 0.99) : 0,
        energy: resistanceAfterArmor.energy !== 0 ? criticalDamagePaper.energy * Math.min(Math.pow((criticalDamagePaper.energy * 0.15 / resistanceAfterArmor.energy), 0.365), 0.99) : 0
      };

      const totals = {
        finalDamage: finalDamage.physical + finalDamage.energy,
        finalCriticalDamage: finalCriticalDamage.physical + finalCriticalDamage.energy
      };
      document.getElementById("finalDamagePhysical").value = Math.round(finalDamage.physical);
      document.getElementById("finalDamageEnergy").value = Math.round(finalDamage.energy);
      document.getElementById("finalDamageTotal").value = Math.round(totals.finalDamage);
      document.getElementById("finalCriticalDamagePhysical").value = Math.round(finalCriticalDamage.physical);
      document.getElementById("finalCriticalDamageEnergy").value = Math.round(finalCriticalDamage.energy);
      document.getElementById("finalCriticalDamageTotal").value = Math.round(totals.finalCriticalDamage);

      let firingRate = isGatPlasma ? 91 * (1 + 0.25 * (state.acceralateActive ? 1 : 0) + 0.25 * (state.rapidActive ? 1 : 0)) : 20;
      const firingRatePerSecond = firingRate / 10;
      document.getElementById("firingRate").value = firingRatePerSecond.toFixed(1);

      const averageDamage = (totals.finalDamage + totals.finalCriticalDamage) / 2;
      const dps = averageDamage * firingRatePerSecond;
      document.getElementById("dps").value = Math.round(dps);

      let reloadSpeedMultiplier = state.reloadSpeedActive ? 1.5 : 1;
      if (isGatPlasma && state.swiftCoreActive) reloadSpeedMultiplier *= 1.5;
      const reloadTime = weaponData[weapon].baseReloadTime / reloadSpeedMultiplier;

      const ftMultiplier = 1.4;
      const toftMultiplier = 1.4;
      const lowHealthMultiplier = 1.5;

      const ftDamagePhysical = damageOnPaper.physical * ftMultiplier;
      const ftDamageEnergy = damageOnPaper.energy * ftMultiplier;
      const ftResistanceCoeffPhysical = Math.min(Math.pow((ftDamagePhysical * 0.15 / resistanceAfterArmor.physical), 0.365), 0.99);
      const ftResistanceCoeffEnergy = Math.min(Math.pow((ftDamageEnergy * 0.15 * 1.4 / resistanceAfterArmor.energy), 0.365 * 1.5), 0.99);
      const ftDamage = Math.round(ftDamagePhysical * ftResistanceCoeffPhysical + ftDamageEnergy * ftResistanceCoeffEnergy);

      const ftCriticalDamagePhysical = (damageOnPaper.physical + criticalDamageAdd.physical) * ftMultiplier;
      const ftCriticalDamageEnergy = (damageOnPaper.energy + criticalDamageAdd.energy) * ftMultiplier;
      const ftCriticalResistanceCoeffPhysical = Math.min(Math.pow((ftCriticalDamagePhysical * 0.15 / resistanceAfterArmor.physical), 0.365), 0.99);
      const ftCriticalResistanceCoeffEnergy = Math.min(Math.pow((ftCriticalDamageEnergy * 0.15 * 1.4 / resistanceAfterArmor.energy), 0.365 * 1.5), 0.99);
      const ftCriticalDamage = Math.round(ftCriticalDamagePhysical * ftCriticalResistanceCoeffPhysical + ftCriticalDamageEnergy * ftCriticalResistanceCoeffEnergy);

      const toftDamagePhysical = damageOnPaper.physical * toftMultiplier;
      const toftDamageEnergy = damageOnPaper.energy * toftMultiplier;
      const toftResistanceCoeffPhysical = Math.min(Math.pow((toftDamagePhysical * 0.15 / resistanceAfterArmor.physical), 0.365), 0.99);
      const toftResistanceCoeffEnergy = Math.min(Math.pow((toftDamageEnergy * 0.15 / resistanceAfterArmor.energy), 0.365), 0.99);
      const toftDamage = Math.round(toftDamagePhysical * toftResistanceCoeffPhysical + toftDamageEnergy * toftResistanceCoeffEnergy);

      const toftCriticalDamagePhysical = (damageOnPaper.physical + criticalDamageAdd.physical) * toftMultiplier;
      const toftCriticalDamageEnergy = (damageOnPaper.energy + criticalDamageAdd.energy) * toftMultiplier;
      const toftCriticalResistanceCoeffPhysical = Math.min(Math.pow((toftCriticalDamagePhysical * 0.15 / resistanceAfterArmor.physical), 0.365), 0.99);
      const toftCriticalResistanceCoeffEnergy = Math.min(Math.pow((toftCriticalDamageEnergy * 0.15 / resistanceAfterArmor.energy), 0.365), 0.99);
      const toftCriticalDamage = Math.round(toftCriticalDamagePhysical * toftCriticalResistanceCoeffPhysical + toftCriticalDamageEnergy * toftCriticalResistanceCoeffEnergy);

      const killTime = parseFloat(document.getElementById("killTime").value || 0);
      const lowHealthBaseMultiplier = (state.perkMultiplierActive && killTime >= 25) ? toftMultiplier : 1;
      const combinedMultiplier = lowHealthBaseMultiplier * lowHealthMultiplier;

      const lowHealthDamagePhysical = damageOnPaper.physical * combinedMultiplier;
      const lowHealthDamageEnergy = damageOnPaper.energy * combinedMultiplier;
      const lowHealthResistanceCoeffPhysical = Math.min(Math.pow((lowHealthDamagePhysical * 0.15 / resistanceAfterArmor.physical), 0.365), 0.99);
      const lowHealthResistanceCoeffEnergy = Math.min(Math.pow((lowHealthDamageEnergy * 0.15 / resistanceAfterArmor.energy), 0.365), 0.99);
      const lowHealthDamage = Math.round(lowHealthDamagePhysical * lowHealthResistanceCoeffPhysical + lowHealthDamageEnergy * lowHealthResistanceCoeffEnergy);

      const lowHealthCriticalDamagePhysical = (damageOnPaper.physical + criticalDamageAdd.physical) * combinedMultiplier;
      const lowHealthCriticalDamageEnergy = (damageOnPaper.energy + criticalDamageAdd.energy) * combinedMultiplier;
      const lowHealthCriticalResistanceCoeffPhysical = Math.min(Math.pow((lowHealthCriticalDamagePhysical * 0.15 / resistanceAfterArmor.physical), 0.365), 0.99);
      const lowHealthCriticalResistanceCoeffEnergy = Math.min(Math.pow((lowHealthCriticalDamageEnergy * 0.15 / resistanceAfterArmor.energy), 0.365), 0.99);
      const lowHealthCriticalDamage = Math.round(lowHealthCriticalDamagePhysical * lowHealthCriticalResistanceCoeffPhysical + lowHealthCriticalDamageEnergy * lowHealthCriticalResistanceCoeffEnergy);

      document.getElementById("ftDamage").value = ftDamage;
      document.getElementById("ftCriticalDamage").value = ftCriticalDamage;
      document.getElementById("toftDamage").value = toftDamage;
      document.getElementById("toftCriticalDamage").value = toftCriticalDamage;
      document.getElementById("lowHealthDamage").value = lowHealthDamage;
      document.getElementById("lowHealthCriticalDamage").value = lowHealthCriticalDamage;

      plotCumulativeDamage(damageOnPaper, criticalDamageAdd, resistanceAfterArmor, firingRatePerSecond, magazineSize, reloadTime);
    }

    function plotCumulativeDamage(damageOnPaper, criticalDamageAdd, resistanceAfterArmor, firingRate, magazineSize, reloadTime) {
      const maxTime = 60;
      const bossMaxHealth = 641055;
      const excusionerThreshold = 0.4 * bossMaxHealth;
      const bodyPartThreshold = 0.1 * bossMaxHealth;
      let health = bossMaxHealth;
      let cumulativeDamage = 0;
      let time = 0;
      const interval = 1 / firingRate;
      let isCritical = false;
      let shotsFired = 0;
      const times = [];
      const dataPoints = [];
      let excusionerTime = null;
      let bodyPartTime = null;
      let killTime = null;

      while (time <= maxTime && health > 0) {
        if (shotsFired >= magazineSize) {
          time += reloadTime;
          shotsFired = 0;
          times.push(time.toFixed(1));
          dataPoints.push(Math.min(cumulativeDamage, bossMaxHealth));
          continue;
        }

        let multiplier = 1;
        if (state.followThroughActive && time <= 10) multiplier *= 1.4;
        if (state.perkMultiplierActive && time >= 25) multiplier *= 1.4;
        if (state.excusionerActive && health <= excusionerThreshold) multiplier *= 1.5;
        if (health <= bodyPartThreshold) multiplier *= 1.5;

        let damagePhysical, damageEnergy;
        if (isCritical) {
          damagePhysical = (damageOnPaper.physical + criticalDamageAdd.physical) * multiplier;
          damageEnergy = (damageOnPaper.energy + criticalDamageAdd.energy) * multiplier;
        } else {
          damagePhysical = damageOnPaper.physical * multiplier;
          damageEnergy = damageOnPaper.energy * multiplier;
        }

        const resistanceCoeffPhysical = Math.min(Math.pow((damagePhysical * 0.15 / resistanceAfterArmor.physical), 0.365), 0.99);
        const resistanceCoeffEnergy = Math.min(Math.pow((damageEnergy * (state.followThroughActive && time <= 10 ? 0.15 * 1.4 : 0.15) / resistanceAfterArmor.energy), (state.followThroughActive && time <= 10 ? 0.365 * 1.5 : 0.365)), 0.99);

        const actualDamagePhysical = damagePhysical * resistanceCoeffPhysical;
        const actualDamageEnergy = damageEnergy * resistanceCoeffEnergy;
        const totalActualDamage = actualDamagePhysical + actualDamageEnergy;

        cumulativeDamage += totalActualDamage;
        health -= totalActualDamage;
        shotsFired++;

        if (health <= excusionerThreshold && !excusionerTime) excusionerTime = time.toFixed(1);
        if (health <= bodyPartThreshold && !bodyPartTime) bodyPartTime = time.toFixed(1);
        if (health <= 0 && !killTime) killTime = time.toFixed(1);

        times.push(time.toFixed(1));
        dataPoints.push(Math.min(cumulativeDamage, bossMaxHealth));
        time += interval;
        isCritical = !isCritical;
      }

      if (time < maxTime) {
        times.push(maxTime.toFixed(1));
        dataPoints.push(Math.min(cumulativeDamage, bossMaxHealth));
      }
      if (!killTime) killTime = time.toFixed(1);

      document.getElementById("killTime").value = killTime;

      const annotations = [];
      let yOffset = 0;
      if (state.perkMultiplierActive && parseFloat(killTime) > 25) {
        annotations.push({ type: 'line', mode: 'vertical', scaleID: 'x', value: 25, borderColor: 'green', borderWidth: 1, label: { content: 'Taking one for the Team 開始', enabled: true, position: 'top', yAdjust: yOffset += 25, font: { size: 16 } } });
      }
      if (state.excusionerActive && excusionerTime) {
        annotations.push({ type: 'line', mode: 'vertical', scaleID: 'x', value: excusionerTime, borderColor: 'orange', borderWidth: 1, label: { content: '処刑人 (40%)', enabled: true, position: 'top', yAdjust: yOffset += 25, font: { size: 16 } } });
      }
      if (bodyPartTime) {
        annotations.push({ type: 'line', mode: 'vertical', scaleID: 'x', value: bodyPartTime, borderColor: 'purple', borderWidth: 1, label: { content: '体力10%', enabled: true, position: 'top', yAdjust: yOffset += 25, font: { size: 16 } } });
      }
      if (parseFloat(killTime) <= 60) {
        annotations.push({ type: 'line', mode: 'vertical', scaleID: 'x', value: killTime, borderColor: 'black', borderWidth: 1, label: { content: `討伐 (${killTime}秒)`, enabled: true, position: 'top', yAdjust: yOffset += 25, font: { size: 16 } } });
      }

      const ctx = document.getElementById("damageGraph").getContext("2d");
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: times,
          datasets: [{
            label: "累積ダメージ",
            data: dataPoints,
            borderColor: "blue",
            fill: false,
            pointRadius: 0
          }]
        },
        options: {
          animation: { duration: 0 },
          scales: {
            x: { type: 'linear', min: 0, max: 60, title: { display: true, text: "時間 (秒)", font: { size: 16 } }, ticks: { stepSize: 10, font: { size: 14 } } },
            y: { title: { display: true, text: "累積ダメージ", font: { size: 16 } }, max: bossMaxHealth, beginAtZero: true, ticks: { font: { size: 14 } } }
          },
          plugins: {
            annotation: { annotations },
            legend: { labels: { font: { size: 16 } } }
          },
          maintainAspectRatio: false
        }
      });
    }

    window.onload = function() {
      updateButtons();
      calculateDamage();
    };
  </script>
</body>
</html>
