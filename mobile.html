<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ダメージ計算＆DPSツール（モバイル版）</title>
  <style>
    html, body { 
      margin: 0; 
      padding: 0; 
      font-size: 16px;
      -webkit-text-size-adjust: 100%;
    }
    
    .container { 
      padding: 10px; 
      max-width: 100%;
    }

    #scrollable-content { 
      margin-bottom: 33vh; 
    }

    table { 
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
    }

    th, td { 
      padding: 10px;
      border: 1px solid #e0e0e0;
      font-size: 0.9rem;
    }

    th {
      background-color: #f2f2f2;
      white-space: normal;
      width: 40%;
    }

    td {
      width: 60%;
    }

    /* 入力フィールドのスタイル */
    input[type="number"], 
    input[type="text"],
    select { 
      width: 70px;
      height: 30px;
      font-size: 1rem;
      padding: 5px;
      margin: 2px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    /* ボタンのスタイル */
    button {
      min-width: 120px;
      height: 44px;
      margin: 5px;
      padding: 10px 15px;
      font-size: 0.9rem;
      border: none;
      border-radius: 8px;
      background-color: #f5f5f5;
      color: #505050;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    button.on {
      background-color: #2196F3;
      color: white;
    }

    button:active {
      transform: scale(0.98);
    }

    /* カテゴリごとの背景色 */
    tr.category-target th { background-color: #E3F2FD; }
    tr.category-weapon th,
    tr.category-mod th { background-color: #E8F5E9; }
    tr.category-legendary th { background-color: #FFF3E0; }
    tr.category-perk th { background-color: #F3E5F5; }
    tr.category-mutation th { background-color: #E8EAF6; }
    tr.category-buff th { background-color: #FBE9E7; }

    /* 言語切り替えボタン */
    .language-switcher {
      padding: 10px;
      text-align: right;
      background-color: white;
    }

    .language-switcher button {
      min-width: 80px;
      height: 36px;
      background-color: #90EE90;
    }

    .language-switcher button.active {
      background-color: #32CD32;
      color: white;
    }

    /* グラフコンテナ */
    #graph-container {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 33vh;
      background-color: white;
      padding: 10px;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
      z-index: 1000;
    }

    #damageGraph {
      width: 100%;
      height: 100%;
    }

    /* ボタングループのラッパー */
    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      justify-content: flex-start;
      margin: 5px 0;
    }

    /* 数値表示セクション */
    .damage-display {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      align-items: center;
    }

    .damage-display span {
      margin: 0 5px;
    }

    /* スクロールバーのカスタマイズ */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    /* モバイル向け追加スタイル */
    @media (max-width: 480px) {
      th, td {
        padding: 8px;
        font-size: 0.85rem;
      }

      button {
        min-width: 100px;
        height: 40px;
        font-size: 0.85rem;
        padding: 8px 12px;
      }

      input[type="number"], 
      input[type="text"],
      select {
        width: 60px;
        height: 28px;
        font-size: 0.9rem;
      }

      .damage-display {
        gap: 3px;
      }

      .damage-display span {
        margin: 0 3px;
      }
    }
  </style>
</head>
<body>
  <div class="language-switcher">
    <button id="jp-btn" class="active" onclick="switchLanguage('jp')">日本語</button>
    <button id="en-btn" onclick="switchLanguage('en')">English</button>
  </div>

  <div class="container">
    <div id="scrollable-content">
      <table>
        <tr>
          <th data-lang-key="normalDamage">通常ダメージ</th>
          <td class="damage-display">
            <span data-lang-key="base">ベース</span>
            <input type="text" id="finalDamageTotal" readonly>
            <span>FT</span>
            <input type="text" id="ftDamage" readonly>
            <span>TOFT</span>
            <input type="text" id="toftDamage" readonly>
            <span data-lang-key="last">ラスト</span>
            <input type="text" id="lowHealthDamage" readonly>
          </td>
        </tr>
        <tr>
          <th data-lang-key="criticalDamage">クリティカル</th>
          <td class="damage-display">
            <span data-lang-key="base">ベース</span>
            <input type="text" id="finalCriticalDamageTotal" readonly>
            <span>FT</span>
            <input type="text" id="ftCriticalDamage" readonly>
            <span>TOFT</span>
            <input type="text" id="toftCriticalDamage" readonly>
            <span data-lang-key="last">ラスト</span>
            <input type="text" id="lowHealthCriticalDamage" readonly>
          </td>
        </tr>
        <tr>
          <th data-lang-key="preset">プリセット</th>
          <td>
            <select id="presetSelect" onchange="applyPreset()">
              <option value="default" data-lang-key="defaultPreset">デフォルト</option>
              <option value="preset1" data-lang-key="preset1">プリセット1</option>
              <option value="preset2" data-lang-key="preset2">プリセット2</option>
            </select>
          </td>
        </tr>
        <tr class="category-target">
          <th data-lang-key="target">攻撃対象</th>
          <td class="button-group">
            <button id="ultraciteTerrorButton" class="on" onclick="toggleExclusiveBonus('ultraciteTerror')" data-lang-key="ultraciteTerror">ウルトラサイトテラー</button>
            <button id="en06Button" class="off" onclick="toggleExclusiveBonus('en06')">EN06</button>
          </td>
        </tr>
        <tr class="category-target">
          <th data-lang-key="bodyPart">攻撃部位</th>
          <td class="button-group">
            <button id="eyeButton" class="on" onclick="toggleExclusiveBonus('eye')" data-lang-key="eye">目</button>
            <button id="headButton" class="off" onclick="toggleExclusiveBonus('head')" data-lang-key="head">頭</button>
            <button id="bodyButton" class="off" onclick="toggleExclusiveBonus('body')" data-lang-key="body">胴体</button>
          </td>
        </tr>
        <tr class="category-weapon">
          <th data-lang-key="weapon">武器</th>
          <td class="button-group">
            <button id="gatPlasmaButton" class="on" onclick="toggleWeapon('gatPlasma')" data-lang-key="gatPlasma">ガトプラ</button>
            <button id="railRifleButton" class="off" onclick="toggleWeapon('railRifle')" data-lang-key="railRifle">レールライフル</button>
          </td>
        </tr>
        <tr class="category-mod">
          <th data-lang-key="weaponMod">武器MOD</th>
          <td>
            <span id="gatPlasmaMods" class="button-group" style="display: inline;">
              <button id="stingingCoreButton" class="on" onclick="toggleExclusiveBonus('stingingCore')" data-lang-key="stingingCore">スティングコア</button>
              <button id="swiftCoreButton" class="off" onclick="toggleExclusiveBonus('swiftCore')" data-lang-key="swiftCore">スウィフトコア</button>
              <button id="primeButton" class="off" onclick="toggleExclusiveBonus('prime')" data-lang-key="prime">プライムレシーバー</button>
              <button id="calibrateButton" class="on" onclick="toggleExclusiveBonus('calibrate')" data-lang-key="calibrate">キャリブレートレシーバー</button>
              <button id="acceralateButton" class="on" onclick="toggleBonus('acceralate')" data-lang-key="acceralate">アクセラレートノズル</button>
            </span>
            <span id="railRifleMods" class="button-group" style="display: none;">
              <button id="autoPistonButton" class="on" onclick="toggleBonus('autoPiston')" data-lang-key="autoPiston">オートピストン</button>
              <button id="primeRailButton" class="off" onclick="toggleExclusiveBonus('primeRail')" data-lang-key="primeRail">プライムレシーバー</button>
            </span>
          </td>
        </tr>
        <tr class="category-legendary">
          <th data-lang-key="legendary1">★1伝説効果</th>
          <td class="button-group">
            <button id="bloodiedButton" class="on" onclick="toggleExclusiveBonus('bloodied')" data-lang-key="bloodied">血濡れ</button>
            <button id="antiArmorButton" class="off" onclick="toggleExclusiveBonus('antiArmor')" data-lang-key="antiArmor">対アーマー</button>
            <button id="excusionerButton" class="off" onclick="toggleExclusiveBonus('excusioner')" data-lang-key="excusioner">処刑人</button>
            <button id="quadButton" class="off" onclick="toggleExclusiveBonus('quad')" data-lang-key="quad">クアッド</button>
          </td>
        </tr>
        <tr class="category-legendary">
          <th data-lang-key="legendary2">★2伝説効果</th>
          <td class="button-group">
            <button id="rapidButton" class="on" onclick="toggleExclusiveBonus('rapid')" data-lang-key="rapid">迅速</button>
            <button id="vitalButton" class="off" onclick="toggleExclusiveBonus('vital')" data-lang-key="vital">バイタル</button>
          </td>
        </tr>
        <tr class="category-legendary">
          <th data-lang-key="legendary3">★3伝説効果</th>
          <td class="button-group">
            <button id="rangersButton" class="on" onclick="toggleBonus('rangers')">Ranger's</button>
            <button id="pinPointersButton" class="on" onclick="toggleBonus('pinPointers')">Pin-Pointer's</button>
            <button id="reloadSpeedButton" class="off" onclick="toggleBonus('reloadSpeed')" data-lang-key="reloadSpeed">リロ速</button>
          </td>
        </tr>
        <tr>
          <th data-lang-key="totalDamageBonus">総ダメージボーナス</th>
          <td><input type="number" id="damageBonus" value="100" readonly> %</td>
        </tr>
        <tr>
          <th data-lang-key="totalCriticalBonus">総クリティカルボーナス</th>
          <td><input type="number" id="criticalBonus" value="100" readonly> %</td>
        </tr>
        <tr class="category-perk">
          <th data-lang-key="damagePerk">ダメージ系Perk</th>
          <td class="button-group">
            <button id="heavyGunnerButton" class="on" onclick="toggleBonus('heavyGunner')">HeavyGunner</button>
            <button id="betterCriticalsButton" class="on" onclick="toggleBonus('betterCriticals')">Better Criticals</button>
            <button id="bMessButton" class="on" onclick="toggleBonus('bMess')">Bloody Mess</button>
            <button id="nerdRageButton" class="on" onclick="toggleBonus('nerdRage')">Nerd Rage</button>
          </td>
        </tr>
        <tr class="category-perk">
          <th data-lang-key="armorPenPerk">アーマー貫通系Perk</th>
          <td class="button-group">
            <button id="stabilizedButton" class="on" onclick="toggleBonus('stabilized')">Stabilized</button>
          </td>
        </tr>
        <tr class="category-perk">
          <th data-lang-key="otherPerk">その他Perk</th>
          <td class="button-group">
            <button id="sinButton" class="on" onclick="toggleBonus('sin')">Strange in Numbers</button>
            <button id="perkMultiplierButton" class="on" onclick="toggleBonus('perkMultiplier')">Taking one for the Team</button>
            <button id="followThroughButton" class="on" onclick="toggleBonus('followThrough')">Follow Through</button>
          </td>
        </tr>
        <tr class="category-mutation">
          <th data-lang-key="mutation">変異</th>
          <td class="button-group">
            <button id="eagleEyesButton" class="on" onclick="toggleBonus('eagleEyes')" data-lang-key="eagleEyes">ワシの目</button>
            <button id="adrenalRButton" class="on" onclick="toggleBonus('adrenalR')" data-lang-key="adrenalR">副腎反応</button>
          </td>
        </tr>
        <tr class="category-buff">
          <th data-lang-key="buff">バフ系</th>
          <td class="button-group">
            <button id="blightSoupButton" class="on" onclick="toggleBonus('blightSoup')" data-lang-key="blightSoup">ブライトのスープ</button>
            <button id="oDriveButton" class="on" onclick="toggleExclusiveBonus('oDrive')" data-lang-key="oDrive">オーバードライブ</button>
            <button id="phyBuffButton" class="off" onclick="toggleExclusiveBonus('phyBuff')" data-lang-key="phyBuff">サイコバフ</button>
            <button id="heavyGunsButton" class="on" onclick="toggleBonus('heavyGuns')" data-lang-key="heavyGuns">HeavyGuns</button>
            <button id="teslaScience9Button" class="off" onclick="toggleBonus('teslaScience9')" data-lang-key="teslaScience9">テスラサイエンス９</button>
          </td>
        </tr>
        <tr>
          <th data-lang-key="firingRate">発射速度</th>
          <td><input type="text" id="firingRate" readonly> <span data-lang-key="shotsPerSecond">発/秒</span></td>
        </tr>
        <tr>
          <th>DPS</th>
          <td><input type="text" id="dps" readonly></td>
        </tr>
        <tr>
          <th data-lang-key="killTime">討伐時間</th>
          <td><input type="text" id="killTime" readonly> <span data-lang-key="seconds">秒</span></td>
        </tr>
        <tr>
          <th data-lang-key="pipboyDamage">PipBoy表記ダメ（物理/エネルギー）</th>
          <td><input type="text" id="gameDisplayDamagePhysical" readonly>/<input type="text" id="gameDisplayDamageEnergy" readonly></td>
        </tr>
        <tr>
          <th data-lang-key="paperDamage">机上のダメージ（物理/エネルギー）</th>
          <td><input type="text" id="damageOnPaperPhysical" readonly>/<input type="text" id="damageOnPaperEnergy" readonly></td>
        </tr>
        <tr>
          <th data-lang-key="resistanceAfterArmorPen">アーマー貫通後耐性（物理/エネルギー）</th>
          <td><input type="text" id="enemyDamageResistancePhysicalAfterArmorPen" readonly>/<input type="text" id="enemyDamageResistanceEnergyAfterArmorPen" readonly></td>
        </tr>
        <tr>
          <th data-lang-key="finalNormalDamage">最終通常ダメージ(物理/エネルギー)</th>
          <td><input type="text" id="finalDamagePhysical" readonly>/<input type="text" id="finalDamageEnergy" readonly></td>
        </tr>
        <tr>
          <th data-lang-key="criticalDamageAdd">クリダメ加算（物理/エネルギー）</th>
          <td><input type="text" id="criticalDamageAddPhysical" readonly>/<input type="text" id="criticalDamageAddEnergy" readonly></td>
        </tr>
        <tr>
          <th data-lang-key="paperCriticalDamage">机上のクリダメ（物理/エネルギー）</th>
          <td><input type="text" id="criticalDamagePaperPhysical" readonly>/<input type="text" id="criticalDamagePaperEnergy" readonly></td>
        </tr>
        <tr>
          <th data-lang-key="finalCriticalDamage">最終クリダメ（物理/エネルギー）</th>
          <td><input type="text" id="finalCriticalDamagePhysical" readonly>/<input type="text" id="finalCriticalDamageEnergy" readonly></td>
        </tr>
      </table>
    </div>
    <div id="graph-container">
      <canvas id="damageGraph"></canvas>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/chartjs-plugin-annotation.min.js"></script>
  <script>
    // 言語データを定義
    const langData = {
      jp: {
        // ヘッダーとタイトル
        normalDamage: "通常ダメージ",
        criticalDamage: "クリティカル",
        base: "ベース",
        last: "ラスト",
        
        // プリセット
        preset: "プリセット",
        defaultPreset: "デフォルト",
        preset1: "プリセット1",
        preset2: "プリセット2",
        
        // 攻撃対象と部位
        target: "攻撃対象",
        ultraciteTerror: "ウルトラサイトテラー",
        bodyPart: "攻撃部位",
        eye: "目",
        head: "頭",
        body: "胴体",
        
        // 武器
        weapon: "武器",
        gatPlasma: "ガトプラ",
        railRifle: "レールライフル",
        
        // 武器MOD
        weaponMod: "武器MOD",
        stingingCore: "スティングコア",
        swiftCore: "スウィフトコア",
        prime: "プライムレシーバー",
        calibrate: "キャリブレートレシーバー",
        acceralate: "アクセラレートノズル",
        autoPiston: "オートピストン",
        primeRail: "プライムレシーバー",
        
        // 伝説効果
        legendary1: "★1伝説効果",
        bloodied: "血濡れ",
        antiArmor: "対アーマー",
        excusioner: "処刑人",
        quad: "クアッド",
        legendary2: "★2伝説効果",
        rapid: "迅速",
        vital: "バイタル",
        legendary3: "★3伝説効果",
        reloadSpeed: "リロ速",
        
        // ボーナスと数値
        totalDamageBonus: "総ダメージボーナス",
        totalCriticalBonus: "総クリティカルボーナス",
        
        // パーク
        damagePerk: "ダメージ系Perk",
        armorPenPerk: "アーマー貫通系Perk",
        otherPerk: "その他Perk",
        
        // 変異とバフ
        mutation: "変異",
        eagleEyes: "ワシの目",
        adrenalR: "副腎反応",
        buff: "バフ系",
        blightSoup: "ブライトのスープ",
        oDrive: "オーバードライブ",
        phyBuff: "サイコバフ",
        heavyGuns: "HeavyGuns",
        teslaScience9: "テスラサイエンス９",
        
        // その他の数値と表示
        firingRate: "発射速度",
        shotsPerSecond: "発/秒",
        killTime: "討伐時間",
        seconds: "秒",
        pipboyDamage: "PipBoy表記ダメ（物理/エネルギー）",
        paperDamage: "机上のダメージ（物理/エネルギー）",
        resistanceAfterArmorPen: "アーマー貫通後耐性（物理/エネルギー）",
        finalNormalDamage: "最終通常ダメージ(物理/エネルギー)",
        criticalDamageAdd: "クリダメ加算（物理/エネルギー）",
        paperCriticalDamage: "机上のクリダメ（物理/エネルギー）",
        finalCriticalDamage: "最終クリダメ（物理/エネルギー）",
        
        // グラフ関連
        graphTime: "時間 (秒)",
        graphCumulativeDamage: "累積ダメージ",
        toftStart: "Taking one for the Team 開始",
        excusionerThreshold: "処刑人 (40%)",
        healthThreshold: "体力10%",
        defeatTime: "討伐 ({0}秒)"
      },
      en: {
        // Headers and titles
        normalDamage: "Normal Damage",
        criticalDamage: "Critical Damage",
        base: "Base",
        last: "Last",
        
        // Presets
        preset: "Preset",
        defaultPreset: "Default",
        preset1: "Preset 1",
        preset2: "Preset 2",
        
        // Attack target and body parts
        target: "Target",
        ultraciteTerror: "Ultracite Terror",
        bodyPart: "Body Part",
        eye: "Eye",
        head: "Head",
        body: "Body",
        
        // Weapons
        weapon: "Weapon",
        gatPlasma: "Gatling Plasma",
        railRifle: "Rail Rifle",
        
        // Weapon mods
        weaponMod: "Weapon Mods",
        stingingCore: "Stinging Core",
        swiftCore: "Swift Core",
        prime: "Prime Receiver",
        calibrate: "Calibrated Receiver",
        acceralate: "Accelerated Nozzle",
        autoPiston: "Auto Piston",
        primeRail: "Prime Receiver",
        
        // Legendary effects
        legendary1: "★1 Legendary Effect",
        bloodied: "Bloodied",
        antiArmor: "Anti-Armor",
        excusioner: "Executioner's",
        quad: "Quad",
        legendary2: "★2 Legendary Effect",
        rapid: "Rapid",
        vital: "Vital",
        legendary3: "★3 Legendary Effect",
        reloadSpeed: "Faster Reload",
        
        // Bonuses and values
        totalDamageBonus: "Total Damage Bonus",
        totalCriticalBonus: "Total Critical Bonus",
        
        // Perks
        damagePerk: "Damage Perks",
        armorPenPerk: "Armor Penetration Perks",
        otherPerk: "Other Perks",
        
        // Mutations and buffs
        mutation: "Mutations",
        eagleEyes: "Eagle Eyes",
        adrenalR: "Adrenal Reaction",
        buff: "Buffs",
        blightSoup: "Blight Soup",
        oDrive: "Overdrive",
        phyBuff: "Psychobuff",
        heavyGuns: "HeavyGuns",
        teslaScience9: "Tesla Science 9",
        
        // Other values and displays
        firingRate: "Firing Rate",
        shotsPerSecond: "shots/sec",
        killTime: "Kill Time",
        seconds: "seconds",
        pipboyDamage: "PipBoy Damage (Physical/Energy)",
        paperDamage: "Paper Damage (Physical/Energy)",
        resistanceAfterArmorPen: "Resistance After Armor Pen (Physical/Energy)",
        finalNormalDamage: "Final Normal Damage (Physical/Energy)",
        criticalDamageAdd: "Critical Damage Add (Physical/Energy)",
        paperCriticalDamage: "Paper Critical Damage (Physical/Energy)",
        finalCriticalDamage: "Final Critical Damage (Physical/Energy)",
        
        // Graph related
        graphTime: "Time (seconds)",
        graphCumulativeDamage: "Cumulative Damage",
        toftStart: "Taking one for the Team Start",
        excusionerThreshold: "Executioner's (40%)",
        healthThreshold: "Health 10%",
        defeatTime: "Defeat ({0}sec)"
      }
    };
    
    // 現在の言語（デフォルトは日本語）
    let currentLang = 'jp';
    
    // 言語切り替え関数
    function switchLanguage(lang) {
      currentLang = lang;
      
      // ボタンのアクティブ状態を更新
      document.getElementById('jp-btn').classList.toggle('active', lang === 'jp');
      document.getElementById('en-btn').classList.toggle('active', lang === 'en');
      
      // すべての言語キーを持つ要素にテキストを適用
      const elements = document.querySelectorAll('[data-lang-key]');
      elements.forEach(el => {
        const key = el.getAttribute('data-lang-key');
        if (langData[lang][key]) {
          // selectの場合はオプションも更新
          if (el.tagName === 'SELECT') {
            Array.from(el.options).forEach(option => {
              const optionKey = option.getAttribute('data-lang-key');
              if (optionKey && langData[lang][optionKey]) {
                option.textContent = langData[lang][optionKey];
              }
            });
          } else {
            el.textContent = langData[lang][key];
          }
        }
      });
      
      // グラフを更新（既に表示されている場合）
      if (chart) {
        updateChartLabels();
      }
    }
    
    // グラフのラベルを更新
    function updateChartLabels() {
      chart.options.scales.x.title.text = langData[currentLang].graphTime;
      chart.options.scales.y.title.text = langData[currentLang].graphCumulativeDamage;
      chart.data.datasets[0].label = langData[currentLang].graphCumulativeDamage;
      
      // アノテーションの更新
      if (chart.options.plugins.annotation.annotations) {
        chart.options.plugins.annotation.annotations.forEach(annotation => {
          if (annotation.label && annotation.label.content) {
            if (annotation.label.content.includes('Taking one for the Team')) {
              annotation.label.content = langData[currentLang].toftStart;
            } else if (annotation.label.content.includes('処刑人') || annotation.label.content.includes('Executioner')) {
              annotation.label.content = langData[currentLang].excusionerThreshold;
            } else if (annotation.label.content.includes('体力') || annotation.label.content.includes('Health')) {
              annotation.label.content = langData[currentLang].healthThreshold;
            } else if (annotation.label.content.includes('討伐') || annotation.label.content.includes('Defeat')) {
              const time = annotation.label.content.match(/\d+(\.\d+)?/)[0];
              annotation.label.content = langData[currentLang].defeatTime.replace('{0}', time);
            }
          }
        });
      }
      
      chart.update();
    }

    const BASE_DAMAGE_BONUS = 1;
    let state = {
      bMessActive: true, primeActive: false, calibrateActive: true, adrenalRActive: true,
      bloodiedActive: true, antiArmorActive: false, excusionerActive: false, quadActive: false,
      blightSoupActive: true,
      heavyGunsActive: true, teslaScience9Active: false, oDriveActive: true, phyBuffActive: false,
      perkMultiplierActive: true, followThroughActive: true, stabilizedActive: false, stingingCoreActive: true,
      pinPointersActive: true, acceralateActive: true, rapidActive: true, vitalActive: false,
      ultraciteTerrorActive: true, en06Active: false,
      eyeActive: true, headActive: false, bodyActive: false,
      gatPlasmaActive: true, railRifleActive: false, autoPistonActive: true, primeRailActive: false,
      swiftCoreActive: false, reloadSpeedActive: false,
      eagleEyesActive: true,
      rangersActive: false,
      nerdRageActive: true,
      betterCriticalsActive: true,
      heavyGunnerActive: true,
      sinActive: true,
      gatPlasmaModsState: {
        stingingCoreActive: true,
        swiftCoreActive: false,
        primeActive: false,
        calibrateActive: true,
        acceralateActive: true
      }
    };
    let chart;

    const resistances = {
      ultraciteTerror: { physical: 183, energy: 213 },
      en06: { physical: 341, energy: 169 }
    };
    const bodyPartMultipliers = {
      eye: 300, head: 200, body: 100
    };
    const weaponData = {
      gatPlasma: {
        damages: { physical: 35, energy: 35 },
        defaultMagazineSize: 500,
        baseReloadTime: 5
      },
      railRifle: {
        damages: { physical: 90, energy: 0 },
        defaultMagazineSize: 10,
        baseReloadTime: 2
      }
    };

    function applyPreset() {
      const preset = document.getElementById("presetSelect").value;
      const defaults = { ultraciteTerrorActive: true, en06Active: false, eyeActive: true, headActive: false, bodyActive: false, gatPlasmaActive: true, eagleEyesActive: false, rangersActive: true, nerdRageActive: true, betterCriticalsActive: true, heavyGunnerActive: true, sinActive: true };
      const presets = {
        preset1: { ...Object.keys(state).reduce((acc, key) => ({ ...acc, [key]: false }), {}), ...defaults },
        preset2: { bMessActive: true, primeActive: true, calibrateActive: false, adrenalRActive: true,
          bloodiedActive: false, antiArmorActive: true, excusionerActive: false, blightSoupActive: true,
          heavyGunsActive: true, teslaScience9Active: true, oDriveActive: false, phyBuffActive: true,
          perkMultiplierActive: true, followThroughActive: false, stabilizedActive: true, stingingCoreActive: true,
          pinPointersActive: true, acceralateActive: true, rapidActive: true, vitalActive: false, ...defaults },
        default: { ...state }
      };
      state = { ...presets[preset] || presets.default };
      updateButtons();
      calculateDamage();
    }

    function toggleBonus(bonus) {
      state[bonus + "Active"] = !state[bonus + "Active"];
      updateButtonClass(bonus + "Button", state[bonus + "Active"]);
      calculateDamage();
    }

    function toggleExclusiveBonus(bonus) {
      const exclusiveGroups = {
        prime: ["calibrate"],
        calibrate: ["prime"],
        swiftCore: ["stingingCore"],
        stingingCore: ["swiftCore"],
        oDrive: ["phyBuff"],
        bloodied: ["antiArmor", "excusioner", "quad"],
        antiArmor: ["bloodied", "excusioner", "quad"],
        excusioner: ["bloodied", "antiArmor", "quad"],
        quad: ["bloodied", "antiArmor", "excusioner"],
        phyBuff: ["oDrive"],
        ultraciteTerror: ["en06"],
        en06: ["ultraciteTerror"],
        eye: ["head", "body"],
        head: ["eye", "body"],
        body: ["eye", "head"],
        rapid: ["vital"],
        vital: ["rapid"]
      };
      state[bonus + "Active"] = !state[bonus + "Active"];
      exclusiveGroups[bonus]?.forEach(ex => state[ex + "Active"] = false);
      updateButtons();
      calculateDamage();
    }

    function updateButtonClass(buttonId, isActive) {
      const button = document.getElementById(buttonId);
      if (button) {
        button.classList.remove("on", "off");
        button.classList.add(isActive ? "on" : "off");
      }
    }

    function updateButtons() {
      Object.keys(state).forEach(key => {
        const buttonId = key.replace("Active", "Button");
        const button = document.getElementById(buttonId);
        if (button) {
          button.classList.remove("on", "off");
          button.classList.add(state[key] ? "on" : "off");
          if (["bloodied", "antiArmor", "excusioner", "quad", "rapid", "vital", "rangers", "pinPointers"].includes(key.replace("Active", ""))) {
            button.classList.add("legendary");
          }
        }
      });
    }

    function toggleWeapon(weapon) {
      if (weapon === "gatPlasma") {
        state.gatPlasmaActive = true;
        state.railRifleActive = false;
        Object.assign(state, state.gatPlasmaModsState);
        document.getElementById("gatPlasmaMods").style.display = "inline";
        document.getElementById("railRifleMods").style.display = "none";
      } else if (weapon === "railRifle") {
        state.gatPlasmaActive = false;
        state.railRifleActive = true;
        state.gatPlasmaModsState = {
          stingingCoreActive: state.stingingCoreActive,
          swiftCoreActive: state.swiftCoreActive,
          primeActive: state.primeActive,
          calibrateActive: state.calibrateActive,
          acceralateActive: state.acceralateActive
        };
        state.stingingCoreActive = false;
        state.swiftCoreActive = false;
        state.primeActive = false;
        state.calibrateActive = false;
        state.acceralateActive = false;
        document.getElementById("gatPlasmaMods").style.display = "none";
        document.getElementById("railRifleMods").style.display = "inline";
      }
      updateButtons();
      calculateDamage();
    }

    function calculateDamage() {
      const enemyType = state.ultraciteTerrorActive ? "ultraciteTerror" : "en06";
      const bodyPart = state.eyeActive ? "eye" : state.headActive ? "head" : "body";
      const weapon = state.gatPlasmaActive ? "gatPlasma" : "railRifle";
      
      let magazineSize = weaponData[weapon].defaultMagazineSize;
      
      if (state.quadActive) {
        magazineSize *= 4;
      }

      const inputs = {
        weaponBaseDamagePhysical: weaponData[weapon].damages.physical,
        weaponBaseDamageEnergy: weaponData[weapon].damages.energy,
        bodyPartMultiplier: bodyPartMultipliers[bodyPart] / 100,
        enemyDamageResistancePhysical: resistances[enemyType].physical,
        enemyDamageResistanceEnergy: resistances[enemyType].energy
      };

      const multipliers = {
        pinPointersMultiplier: state.pinPointersActive ? 1.5 : 1,
        armorPenPerk: state.stabilizedActive ? 0.45 : 0,
        armorPenWeapon: state.stingingCoreActive ? 0.20 : 0,
        armorPenAntiArmor: state.antiArmorActive ? 0.50 : 0
      };

      let damageBonus = BASE_DAMAGE_BONUS +
        (state.bMessActive ? 0.15 : 0) + (state.primeActive ? 0.20 : 0) +
        (state.adrenalRActive ? (state.sinActive ? 0.625 : 0.50) : 0) +
        (state.bloodiedActive ? 0.95 : 0) + (state.heavyGunsActive ? 0.20 : 0) +
        (state.oDriveActive ? 0.15 : 0) + (state.phyBuffActive ? 0.25 : 0) +
        (state.rangersActive ? 0.25 : 0) + (state.nerdRageActive ? 0.20 : 0) +
        (state.heavyGunnerActive ? 0.60 : 0);
      let criticalBonus = 1 + (state.calibrateActive ? 1.00 : 0) +
        (state.blightSoupActive ? (state.sinActive ? 1.25 : 1.00) : 0) +
        (state.teslaScience9Active ? 1.00 : 0) + (state.oDriveActive ? 0.30 : 0) +
        (state.eagleEyesActive ? (state.sinActive ? 0.625 : 0.50) : 0) +
        (state.betterCriticalsActive ? 1.00 : 0) +
        (state.vitalActive ? 0.50 : 0);

      document.getElementById("damageBonus").value = Math.round(damageBonus * 100);
      document.getElementById("criticalBonus").value = Math.round(criticalBonus * 100);

      const gameDisplayDamage = {
        physical: inputs.weaponBaseDamagePhysical * damageBonus,
        energy: inputs.weaponBaseDamageEnergy * damageBonus
      };
      document.getElementById("gameDisplayDamagePhysical").value = Math.round(gameDisplayDamage.physical);
      document.getElementById("gameDisplayDamageEnergy").value = Math.round(gameDisplayDamage.energy);

      const damageOnPaper = {
        physical: inputs.weaponBaseDamagePhysical * damageBonus * inputs.bodyPartMultiplier * multipliers.pinPointersMultiplier,
        energy: inputs.weaponBaseDamageEnergy * damageBonus * inputs.bodyPartMultiplier * multipliers.pinPointersMultiplier
      };
      const resistanceAfterArmor = {
        physical: inputs.enemyDamageResistancePhysical * (1 - multipliers.armorPenPerk) * (1 - multipliers.armorPenWeapon) * (1 - multipliers.armorPenAntiArmor),
        energy: inputs.enemyDamageResistanceEnergy * (1 - multipliers.armorPenPerk) * (1 - multipliers.armorPenWeapon) * (1 - multipliers.armorPenAntiArmor)
      };
      const resistanceCoeff = {
        physical: Math.min(Math.pow((damageOnPaper.physical * 0.15 / resistanceAfterArmor.physical), 0.365), 0.99),
        energy: Math.min(Math.pow((damageOnPaper.energy * 0.15 / resistanceAfterArmor.energy), 0.365), 0.99)
      };
      const finalDamage = {
        physical: damageOnPaper.physical * resistanceCoeff.physical,
        energy: damageOnPaper.energy * resistanceCoeff.energy
      };

      document.getElementById("enemyDamageResistancePhysicalAfterArmorPen").value = Math.round(resistanceAfterArmor.physical);
      document.getElementById("enemyDamageResistanceEnergyAfterArmorPen").value = Math.round(resistanceAfterArmor.energy);

      const criticalDamageAdd = {
        physical: inputs.weaponBaseDamagePhysical * criticalBonus * inputs.bodyPartMultiplier,
        energy: inputs.weaponBaseDamageEnergy * criticalBonus * inputs.bodyPartMultiplier
      };
      const criticalDamagePaper = {
        physical: damageOnPaper.physical + criticalDamageAdd.physical,
        energy: damageOnPaper.energy + criticalDamageAdd.energy
      };
      document.getElementById("damageOnPaperPhysical").value = Math.round(damageOnPaper.physical);
      document.getElementById("damageOnPaperEnergy").value = Math.round(damageOnPaper.energy);
      document.getElementById("criticalDamageAddPhysical").value = Math.round(criticalDamageAdd.physical);
      document.getElementById("criticalDamageAddEnergy").value = Math.round(criticalDamageAdd.energy);
      document.getElementById("criticalDamagePaperPhysical").value = Math.round(criticalDamagePaper.physical);
      document.getElementById("criticalDamagePaperEnergy").value = Math.round(criticalDamagePaper.energy);

      const finalCriticalDamage = {
        physical: resistanceAfterArmor.physical !== 0 ? criticalDamagePaper.physical * Math.min(Math.pow((criticalDamagePaper.physical * 0.15 / resistanceAfterArmor.physical), 0.365), 0.99) : 0,
        energy: resistanceAfterArmor.energy !== 0 ? criticalDamagePaper.energy * Math.min(Math.pow((criticalDamagePaper.energy * 0.15 / resistanceAfterArmor.energy), 0.365), 0.99) : 0
      };

      const totals = {
        finalDamage: finalDamage.physical + finalDamage.energy,
        finalCriticalDamage: finalCriticalDamage.physical + finalCriticalDamage.energy
      };
      document.getElementById("finalDamagePhysical").value = Math.round(finalDamage.physical);
      document.getElementById("finalDamageEnergy").value = Math.round(finalDamage.energy);
      document.getElementById("finalDamageTotal").value = Math.round(totals.finalDamage);
      document.getElementById("finalCriticalDamagePhysical").value = Math.round(finalCriticalDamage.physical);
      document.getElementById("finalCriticalDamageEnergy").value = Math.round(finalCriticalDamage.energy);
      document.getElementById("finalCriticalDamageTotal").value = Math.round(totals.finalCriticalDamage);

      let firingRate = weapon === "gatPlasma" ? 91 * (1 + 0.25 * (state.acceralateActive ? 1 : 0) + 0.25 * (state.rapidActive ? 1 : 0)) : 20;
      const firingRatePerSecond = firingRate / 10;
      document.getElementById("firingRate").value = firingRatePerSecond.toFixed(1);

      const averageDamage = (totals.finalDamage + totals.finalCriticalDamage) / 2;
      const dps = averageDamage * firingRatePerSecond;
      document.getElementById("dps").value = Math.round(dps);

      let reloadSpeedMultiplier = state.reloadSpeedActive ? 1.5 : 1;
      if (weapon === "gatPlasma" && state.swiftCoreActive) reloadSpeedMultiplier *= 1.5;
      const reloadTime = weaponData[weapon].baseReloadTime / reloadSpeedMultiplier;

      const ftMultiplier = 1.4;
      const toftMultiplier = 1.4;
      const lowHealthMultiplier = 1.5;

      const ftDamagePhysical = damageOnPaper.physical * ftMultiplier;
      const ftDamageEnergy = damageOnPaper.energy * ftMultiplier;
      const ftResistanceCoeffPhysical = Math.min(Math.pow((ftDamagePhysical * 0.15 / resistanceAfterArmor.physical), 0.365), 0.99);
      const ftResistanceCoeffEnergy = Math.min(Math.pow((ftDamageEnergy * 0.15 * 1.4 / resistanceAfterArmor.energy), 0.365 * 1.5), 0.99);
      const ftDamage = Math.round(ftDamagePhysical * ftResistanceCoeffPhysical + ftDamageEnergy * ftResistanceCoeffEnergy);

      const ftCriticalDamagePhysical = (damageOnPaper.physical + criticalDamageAdd.physical) * ftMultiplier;
      const ftCriticalDamageEnergy = (damageOnPaper.energy + criticalDamageAdd.energy) * ftMultiplier;
      const ftCriticalResistanceCoeffPhysical = Math.min(Math.pow((ftCriticalDamagePhysical * 0.15 / resistanceAfterArmor.physical), 0.365), 0.99);
      const ftCriticalResistanceCoeffEnergy = Math.min(Math.pow((ftCriticalDamageEnergy * 0.15 * 1.4 / resistanceAfterArmor.energy), 0.365 * 1.5), 0.99);
      const ftCriticalDamage = Math.round(ftCriticalDamagePhysical * ftCriticalResistanceCoeffPhysical + ftCriticalDamageEnergy * ftCriticalResistanceCoeffEnergy);

      const toftDamagePhysical = damageOnPaper.physical * toftMultiplier;
      const toftDamageEnergy = damageOnPaper.energy * toftMultiplier;
      const toftResistanceCoeffPhysical = Math.min(Math.pow((toftDamagePhysical * 0.15 / resistanceAfterArmor.physical), 0.365), 0.99);
      const toftResistanceCoeffEnergy = Math.min(Math.pow((toftDamageEnergy * 0.15 / resistanceAfterArmor.energy), 0.365), 0.99);
      const toftDamage = Math.round(toftDamagePhysical * toftResistanceCoeffPhysical + toftDamageEnergy * toftResistanceCoeffEnergy);

      const toftCriticalDamagePhysical = (damageOnPaper.physical + criticalDamageAdd.physical) * toftMultiplier;
      const toftCriticalDamageEnergy = (damageOnPaper.energy + criticalDamageAdd.energy) * toftMultiplier;
      const toftCriticalResistanceCoeffPhysical = Math.min(Math.pow((toftCriticalDamagePhysical * 0.15 / resistanceAfterArmor.physical), 0.365), 0.99);
      const toftCriticalResistanceCoeffEnergy = Math.min(Math.pow((toftCriticalDamageEnergy * 0.15 / resistanceAfterArmor.energy), 0.365), 0.99);
      const toftCriticalDamage = Math.round(toftCriticalDamagePhysical * toftCriticalResistanceCoeffPhysical + toftCriticalDamageEnergy * toftCriticalResistanceCoeffEnergy);

      const killTime = parseFloat(document.getElementById("killTime").value || 0);
      const lowHealthBaseMultiplier = (state.perkMultiplierActive && killTime >= 25) ? toftMultiplier : 1;
      const combinedMultiplier = lowHealthBaseMultiplier * lowHealthMultiplier;

      const lowHealthDamagePhysical = damageOnPaper.physical * combinedMultiplier;
      const lowHealthDamageEnergy = damageOnPaper.energy * combinedMultiplier;
      const lowHealthResistanceCoeffPhysical = Math.min(Math.pow((lowHealthDamagePhysical * 0.15 / resistanceAfterArmor.physical), 0.365), 0.99);
      const lowHealthResistanceCoeffEnergy = Math.min(Math.pow((lowHealthDamageEnergy * 0.15 / resistanceAfterArmor.energy), 0.365), 0.99);
      const lowHealthDamage = Math.round(lowHealthDamagePhysical * lowHealthResistanceCoeffPhysical + lowHealthDamageEnergy * lowHealthResistanceCoeffEnergy);

      const lowHealthCriticalDamagePhysical = (damageOnPaper.physical + criticalDamageAdd.physical) * combinedMultiplier;
      const lowHealthCriticalDamageEnergy = (damageOnPaper.energy + criticalDamageAdd.energy) * combinedMultiplier;
      const lowHealthCriticalResistanceCoeffPhysical = Math.min(Math.pow((lowHealthCriticalDamagePhysical * 0.15 / resistanceAfterArmor.physical), 0.365), 0.99);
      const lowHealthCriticalResistanceCoeffEnergy = Math.min(Math.pow((lowHealthCriticalDamageEnergy * 0.15 / resistanceAfterArmor.energy), 0.365), 0.99);
      const lowHealthCriticalDamage = Math.round(lowHealthCriticalDamagePhysical * lowHealthCriticalResistanceCoeffPhysical + lowHealthCriticalDamageEnergy * lowHealthCriticalResistanceCoeffEnergy);

      document.getElementById("ftDamage").value = ftDamage;
      document.getElementById("ftCriticalDamage").value = ftCriticalDamage;
      document.getElementById("toftDamage").value = toftDamage;
      document.getElementById("toftCriticalDamage").value = toftCriticalDamage;
      document.getElementById("lowHealthDamage").value = lowHealthDamage;
      document.getElementById("lowHealthCriticalDamage").value = lowHealthCriticalDamage;

      plotCumulativeDamage(damageOnPaper, criticalDamageAdd, resistanceAfterArmor, firingRatePerSecond, magazineSize, reloadTime);
    }

    function plotCumulativeDamage(damageOnPaper, criticalDamageAdd, resistanceAfterArmor, firingRate, magazineSize, reloadTime) {
      const maxTime = 60;
      const bossMaxHealth = 641055;
      const excusionerThreshold = 0.4 * bossMaxHealth;
      const bodyPartThreshold = 0.1 * bossMaxHealth;
      let health = bossMaxHealth;
      let cumulativeDamage = 0;
      let time = 0;
      const interval = 1 / firingRate;
      let isCritical = false;
      let shotsFired = 0;
      const times = [];
      const dataPoints = [];
      let excusionerTime = null;
      let bodyPartTime = null;
      let killTime = null;

      while (time <= maxTime && health > 0) {
        if (shotsFired >= magazineSize) {
          time += reloadTime;
          shotsFired = 0;
          times.push(time.toFixed(1));
          dataPoints.push(Math.min(cumulativeDamage, bossMaxHealth));
          continue;
        }

        let multiplier = 1;
        if (state.followThroughActive && time <= 10) multiplier *= 1.4;
        if (state.perkMultiplierActive && time >= 25) multiplier *= 1.4;
        if (state.excusionerActive && health <= excusionerThreshold) multiplier *= 1.5;
        if (health <= bodyPartThreshold) multiplier *= 1.5;

        let damagePhysical, damageEnergy;
        if (isCritical) {
          damagePhysical = (damageOnPaper.physical + criticalDamageAdd.physical) * multiplier;
          damageEnergy = (damageOnPaper.energy + criticalDamageAdd.energy) * multiplier;
        } else {
          damagePhysical = damageOnPaper.physical * multiplier;
          damageEnergy = damageOnPaper.energy * multiplier;
        }

        const resistanceCoeffPhysical = Math.min(Math.pow((damagePhysical * 0.15 / resistanceAfterArmor.physical), 0.365), 0.99);
        const resistanceCoeffEnergy = Math.min(Math.pow((damageEnergy * (state.followThroughActive && time <= 10 ? 0.15 * 1.4 : 0.15) / resistanceAfterArmor.energy), (state.followThroughActive && time <= 10 ? 0.365 * 1.5 : 0.365)), 0.99);

        const actualDamagePhysical = damagePhysical * resistanceCoeffPhysical;
        const actualDamageEnergy = damageEnergy * resistanceCoeffEnergy;
        const totalActualDamage = actualDamagePhysical + actualDamageEnergy;

        cumulativeDamage += totalActualDamage;
        health -= totalActualDamage;
        shotsFired++;

        if (health <= excusionerThreshold && !excusionerTime) excusionerTime = time.toFixed(1);
        if (health <= bodyPartThreshold && !bodyPartTime) bodyPartTime = time.toFixed(1);
        if (health <= 0 && !killTime) killTime = time.toFixed(1);

        times.push(time.toFixed(1));
        dataPoints.push(Math.min(cumulativeDamage, bossMaxHealth));
        time += interval;
        isCritical = !isCritical;
      }

      if (time < maxTime) {
        times.push(maxTime.toFixed(1));
        dataPoints.push(Math.min(cumulativeDamage, bossMaxHealth));
      }
      if (!killTime) killTime = time.toFixed(1);

      document.getElementById("killTime").value = killTime;

      const annotations = [];
      let yOffset = 0;
      if (state.perkMultiplierActive && parseFloat(killTime) > 25) {
        annotations.push({ type: 'line', mode: 'vertical', scaleID: 'x', value: 25, borderColor: 'green', borderWidth: 1, label: { content: 'Taking one for the Team 開始', enabled: true, position: 'top', yAdjust: yOffset += 25, font: { size: 16 } } });
      }
      if (state.excusionerActive && excusionerTime) {
        annotations.push({ type: 'line', mode: 'vertical', scaleID: 'x', value: excusionerTime, borderColor: 'orange', borderWidth: 1, label: { content: '処刑人 (40%)', enabled: true, position: 'top', yAdjust: yOffset += 25, font: { size: 16 } } });
      }
      if (bodyPartTime) {
        annotations.push({ type: 'line', mode: 'vertical', scaleID: 'x', value: bodyPartTime, borderColor: 'purple', borderWidth: 1, label: { content: '体力10%', enabled: true, position: 'top', yAdjust: yOffset += 25, font: { size: 16 } } });
      }
      if (parseFloat(killTime) <= 60) {
        annotations.push({ type: 'line', mode: 'vertical', scaleID: 'x', value: killTime, borderColor: 'black', borderWidth: 1, label: { content: `討伐 (${killTime}秒)`, enabled: true, position: 'top', yAdjust: yOffset += 25, font: { size: 16 } } });
      }

      const ctx = document.getElementById("damageGraph").getContext("2d");
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: times,
          datasets: [{
            label: langData[currentLang].graphCumulativeDamage,
            data: dataPoints,
            borderColor: "blue",
            fill: false,
            pointRadius: 0
          }]
        },
        options: {
          animation: { duration: 0 },
          scales: {
            x: { 
              type: 'linear', 
              min: 0, 
              max: 60, 
              title: { 
                display: true, 
                text: langData[currentLang].graphTime, 
                font: { size: 16 } 
              }, 
              ticks: { stepSize: 10, font: { size: 14 } } 
            },
            y: { 
              title: { 
                display: true, 
                text: langData[currentLang].graphCumulativeDamage, 
                font: { size: 16 } 
              }, 
              max: bossMaxHealth, 
              beginAtZero: true, 
              ticks: { font: { size: 14 } } 
            }
          },
          plugins: {
            annotation: { annotations },
            legend: { labels: { font: { size: 16 } } }
          },
          maintainAspectRatio: false
        }
      });
    }

    window.onload = function() {
      // 初期言語を適用
      switchLanguage(currentLang);
      
      // モバイル向けの追加処理
      if ('ontouchstart' in window) {
        const buttons = document.querySelectorAll('button');
        buttons.forEach(button => {
          button.addEventListener('touchstart', function() {
            this.classList.add('touch');
          }, false);
          
          button.addEventListener('touchend', function() {
            this.classList.remove('touch');
          }, false);
        });
      }
      
      updateButtons();
      calculateDamage();
    };
  </script>
</body>
</html> 